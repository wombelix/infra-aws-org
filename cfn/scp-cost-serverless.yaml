# SPDX-FileCopyrightText: 2025 Dominik Wombacher <dominik@wombacher.cc>
#
# SPDX-License-Identifier: MIT-0

AWSTemplateFormatVersion: '2010-09-09'
Description: "Service Control Policies for AWS Organizations - Cost optimization policies for serverless services (NOT DEPLOYED - see scp-cost.yaml)"

# =============================================================================
# STATUS: PARTIALLY MIGRATED TO scp-cost.yaml
# =============================================================================
#
# MIGRATED (now in scp-cost.yaml):
# - DenyHighCostLambdaFeatures/DenyProvisionedConcurrency -> DenyLambdaProvisionedConcurrency
# - DenyHighCostLambdaFeatures/DenyProvisionedModeESM     -> DenyLambdaProvisionedESM
# - DenyHighCostDynamoDBFeatures/DenyReservedCapacity     -> DenyDynamoDBReservedCapacity
# - DenyHighCostDynamoDBFeatures/DenyGlobalTables         -> DenyDynamoDBGlobalTables
# - DenyHighCostAPIGatewayFeatures/DenyAPIGatewayVPCEndpoints -> DenyAPIGatewayVPCEndpoints
# - DenyHighCostBedrockFeatures (core parts)              -> DenyBedrockProvisionedThroughput,
#                                                            DenyBedrockCustomModels,
#                                                            DenyBedrockMarketplace
# - DenyExpensiveAnalyticsAndMessaging/DenyAmazonMQ       -> DenyStreamingAndMessaging
#
# NOT MIGRATED (kept below for reference - too risky, unreliable, or limiting):
# - DenyHighCostLambdaFeatures/DenyLambdaEdge    (flawed condition logic)
# - DenyHighCostDynamoDBFeatures/DenyProvisionedCapacity (BillingMode condition unreliable)
# - DenyHighCostAPIGatewayFeatures/DenyRESTAPIs  (REST APIs needed for Cognito, WAF)
# - DenyHighCostStepFunctionsFeatures            (Standard workflows needed for >5min)
# - DenyHighCostBedrockFeatures (complex conditions) (conditions may not work reliably)
# - DenyExpensiveAnalyticsFeatures               (Glue/Athena edge cases)
#
# =============================================================================

Parameters:
  OrganizationRootId:
    Type: String
    Description: "AWS Organizations root ID (e.g., r-xxxx)"

Resources:
  # =============================================================================
  # REMAINING POLICIES - NOT MIGRATED (risky, unreliable, or too limiting)
  # =============================================================================

  # Lambda@Edge blocking
  # WARNING: This condition is FLAWED - it requires BOTH conditions to be true
  # but they use AND logic, which may not work as expected.
  DenyLambdaEdge:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyLambdaEdge
      Description: |
        Block Lambda@Edge functions. WARNING: Condition logic is flawed.
        May block all us-east-1 functions. Test thoroughly before deploying.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyLambdaEdge
            Effect: Deny
            Action:
              - 'lambda:CreateFunction'
              - 'lambda:UpdateFunctionCode'
              - 'lambda:UpdateFunctionConfiguration'
            Resource: '*'
            Condition:
              StringLike:
                'lambda:FunctionArn': 'arn:aws:lambda:us-east-1:*:function:*'
              StringEquals:
                'lambda:Principal': 'edgelambda.amazonaws.com'
      TargetIds:
        - !Ref OrganizationRootId

  # DynamoDB billing mode enforcement
  # WARNING: dynamodb:BillingMode condition doesn't work reliably in SCPs.
  DenyDynamoDBProvisionedCapacity:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyDynamoDBProvisionedCapacity
      Description: |
        Force DynamoDB on-demand capacity. WARNING: BillingMode condition unreliable.
        May not work as expected. Test in sandbox before deploying.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyProvisionedCapacity
            Effect: Deny
            Action:
              - 'dynamodb:CreateTable'
              - 'dynamodb:UpdateTable'
            Resource: '*'
            Condition:
              StringNotEquals:
                'dynamodb:BillingMode': 'PAY_PER_REQUEST'
      TargetIds:
        - !Ref OrganizationRootId

  # API Gateway REST API restrictions
  # WARNING: REST APIs may be needed for Cognito authorizers, WAF integration,
  # request validation, API keys, usage plans, and other features not in HTTP APIs.
  DenyRESTAPIs:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyRESTAPIs
      Description: |
        Force HTTP APIs by blocking REST APIs. WARNING: REST APIs needed for
        Cognito authorizers, WAF, request validation, API keys. Review carefully.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyRESTAPIs
            Effect: Deny
            Action:
              - 'apigateway:CreateRestApi'
              - 'apigateway:ImportRestApi'
              - 'apigateway:CloneRestApi'
              - 'apigateway:PutRestApi'
            Resource: '*'
      TargetIds:
        - !Ref OrganizationRootId

  # Step Functions Express-only enforcement
  # WARNING: Standard workflows are required for executions >5 minutes.
  # Express workflows have 5-minute max duration limit.
  DenyStandardWorkflows:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyStandardWorkflows
      Description: |
        Force Express Workflows. WARNING: Standard workflows required for >5 min executions.
        Don't deploy if you have long-running workflows.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: ForceExpressWorkflows
            Effect: Deny
            Action:
              - 'states:CreateStateMachine'
              - 'states:UpdateStateMachine'
            Resource: '*'
            Condition:
              StringNotEquals:
                'states:StateMachineType': 'EXPRESS'
      TargetIds:
        - !Ref OrganizationRootId

  # Bedrock complex conditions (human eval, data automation)
  # WARNING: These conditions may not work reliably or may become outdated.
  DenyBedrockComplexFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyBedrockComplexFeatures
      Description: |
        Block Bedrock features with complex conditions. WARNING: Conditions may be unreliable.
        Core Bedrock cost controls are in scp-cost.yaml.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyHumanEvaluation
            Effect: Deny
            Action:
              - 'bedrock:CreateEvaluationJob'
            Resource: '*'
            Condition:
              StringEquals:
                'bedrock:EvaluationType': 'Human'
          - Sid: DenyDataAutomationCustomOutput
            Effect: Deny
            Action:
              - 'bedrock:InvokeModel'
            Resource: '*'
            Condition:
              StringLike:
                'bedrock:ModelId': '*data-automation*'
              StringEquals:
                'bedrock:OutputType': 'Custom'
      TargetIds:
        - !Ref OrganizationRootId

  # Analytics edge cases - Glue dev endpoints, Athena provisioned capacity
  DenyExpensiveAnalyticsFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyExpensiveAnalyticsFeatures
      Description: |
        Block expensive analytics features. These are edge cases unlikely to be used.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyGlueDevelopmentEndpoints
            Effect: Deny
            Action:
              - 'glue:CreateDevEndpoint'
            Resource: '*'
          - Sid: DenyAthenaProvisionedCapacity
            Effect: Deny
            Action:
              - 'athena:CreateCapacityReservation'
            Resource: '*'
      TargetIds:
        - !Ref OrganizationRootId

Outputs:
  DenyLambdaEdgePolicyId:
    Description: Lambda@Edge Deny SCP Policy ID
    Value: !Ref DenyLambdaEdge
    Export:
      Name: !Sub "${AWS::StackName}-DenyLambdaEdge-PolicyId"
  DenyDynamoDBProvisionedCapacityPolicyId:
    Description: DynamoDB Provisioned Capacity Deny SCP Policy ID
    Value: !Ref DenyDynamoDBProvisionedCapacity
    Export:
      Name: !Sub "${AWS::StackName}-DenyDynamoDBProvisionedCapacity-PolicyId"
  DenyRESTAPIsPolicyId:
    Description: REST APIs Deny SCP Policy ID
    Value: !Ref DenyRESTAPIs
    Export:
      Name: !Sub "${AWS::StackName}-DenyRESTAPIs-PolicyId"
  DenyStandardWorkflowsPolicyId:
    Description: Standard Workflows Deny SCP Policy ID
    Value: !Ref DenyStandardWorkflows
    Export:
      Name: !Sub "${AWS::StackName}-DenyStandardWorkflows-PolicyId"
  DenyBedrockComplexFeaturesPolicyId:
    Description: Bedrock Complex Features Deny SCP Policy ID
    Value: !Ref DenyBedrockComplexFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyBedrockComplexFeatures-PolicyId"
  DenyExpensiveAnalyticsFeaturesPolicyId:
    Description: Expensive Analytics Features Deny SCP Policy ID
    Value: !Ref DenyExpensiveAnalyticsFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyExpensiveAnalyticsFeatures-PolicyId"
