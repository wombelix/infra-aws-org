# SPDX-FileCopyrightText: 2025 Dominik Wombacher <dominik@wombacher.cc>
#
# SPDX-License-Identifier: MIT-0

AWSTemplateFormatVersion: '2010-09-09'
Description: "Service Control Policies for AWS Organizations - Cost optimization policies for serverless services (NOT DEPLOYED - see scp-cost.yaml)"

# =============================================================================
# STATUS: PARTIALLY MIGRATED TO scp-cost.yaml
# =============================================================================
#
# MIGRATED (now in scp-cost.yaml):
# - DenyHighCostLambdaFeatures/DenyProvisionedConcurrency -> DenyLambdaProvisionedConcurrency
# - DenyExpensiveAnalyticsAndMessaging/DenyAmazonMQ       -> DenyStreamingAndMessaging
#
# NOT MIGRATED (kept below for reference - considered too risky or unreliable):
# - DenyHighCostLambdaFeatures/DenyProvisionedModeESM  (condition may not work reliably)
# - DenyHighCostLambdaFeatures/DenyLambdaEdge          (flawed condition logic)
# - DenyHighCostDynamoDBFeatures                       (BillingMode condition unreliable in SCPs)
# - DenyHighCostAPIGatewayFeatures                     (REST APIs may be needed for Cognito, WAF)
# - DenyHighCostStepFunctionsFeatures                  (Standard workflows needed for >5min)
# - DenyHighCostBedrockFeatures                        (Bedrock evolving rapidly, revisit later)
# - DenyExpensiveAnalyticsAndMessaging (partial)       (Glue/Athena parts are edge cases)
#
# =============================================================================

Parameters:
  OrganizationRootId:
    Type: String
    Description: "AWS Organizations root ID (e.g., r-xxxx)"

Resources:
  # =============================================================================
  # REMAINING POLICIES - NOT MIGRATED (risky, unreliable, or too limiting)
  # =============================================================================

  # Lambda edge cases - provisioned ESM pollers and Lambda@Edge
  # WARNING: Conditions may not work reliably. Lambda@Edge condition is flawed.
  DenyHighCostLambdaFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyHighCostLambdaFeatures
      Description: |
        Block Lambda features with fixed costs. WARNING: Conditions may be unreliable.
        DenyLambdaEdge condition is flawed - would block all us-east-1 functions.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyProvisionedModeESM
            Effect: Deny
            Action:
              - 'lambda:CreateEventSourceMapping'
              - 'lambda:UpdateEventSourceMapping'
            Resource: '*'
            Condition:
              'Null':
                'lambda:ProvisionedPollerConfig': 'false'
          # WARNING: This condition is FLAWED - it requires BOTH conditions to be true
          # but they use AND logic, so it would block us-east-1 functions even without
          # edgelambda principal if both conditions aren't checked properly
          - Sid: DenyLambdaEdge
            Effect: Deny
            Action:
              - 'lambda:CreateFunction'
              - 'lambda:UpdateFunctionCode'
              - 'lambda:UpdateFunctionConfiguration'
            Resource: '*'
            Condition:
              StringLike:
                'lambda:FunctionArn': 'arn:aws:lambda:us-east-1:*:function:*'
              StringEquals:
                'lambda:Principal': 'edgelambda.amazonaws.com'
      TargetIds:
        - !Ref OrganizationRootId

  # DynamoDB billing mode enforcement
  # WARNING: dynamodb:BillingMode condition doesn't work reliably in SCPs.
  # AWS doesn't always pass this context key. Test thoroughly before deploying.
  DenyHighCostDynamoDBFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyHighCostDynamoDBFeatures
      Description: |
        Force DynamoDB on-demand capacity. WARNING: BillingMode condition unreliable.
        May not work as expected. Test in sandbox before deploying.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyProvisionedCapacity
            Effect: Deny
            Action:
              - 'dynamodb:CreateTable'
              - 'dynamodb:ModifyTable'
              - 'dynamodb:UpdateTable'
            Resource: '*'
            Condition:
              StringNotEquals:
                'dynamodb:BillingMode': 'PAY_PER_REQUEST'
          - Sid: DenyReservedCapacity
            Effect: Deny
            Action:
              - 'dynamodb:PurchaseReservedCapacityOfferings'
              - 'dynamodb:DescribeReservedCapacity'
              - 'dynamodb:DescribeReservedCapacityOfferings'
            Resource: '*'
          - Sid: DenyGlobalTables
            Effect: Deny
            Action:
              - 'dynamodb:CreateGlobalTable'
              - 'dynamodb:UpdateGlobalTable'
              - 'dynamodb:CreateReplicationGroup'
            Resource: '*'
      TargetIds:
        - !Ref OrganizationRootId

  # API Gateway REST API restrictions
  # WARNING: REST APIs may be needed for Cognito authorizers, WAF integration,
  # request validation, API keys, usage plans, and other features not in HTTP APIs.
  DenyHighCostAPIGatewayFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyHighCostAPIGatewayFeatures
      Description: |
        Force HTTP APIs by blocking REST APIs. WARNING: REST APIs needed for
        Cognito authorizers, WAF, request validation, API keys. Review carefully.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyRESTAPIs
            Effect: Deny
            Action:
              - 'apigateway:CreateRestApi'
              - 'apigateway:ImportRestApi'
              - 'apigateway:CloneRestApi'
              - 'apigateway:PutRestApi'
            Resource: '*'
          - Sid: DenyPrivateAPIs
            Effect: Deny
            Action:
              - 'apigateway:CreateRestApi'
              - 'apigateway:ImportRestApi'
            Resource: '*'
            Condition:
              StringEquals:
                'apigateway:Request/EndpointType': 'PRIVATE'
          - Sid: DenyAPIGatewayVPCEndpoints
            Effect: Deny
            Action:
              - 'ec2:CreateVpcEndpoint'
            Resource: '*'
            Condition:
              StringEquals:
                'ec2:VpceServiceName': 'com.amazonaws.*.execute-api'
      TargetIds:
        - !Ref OrganizationRootId

  # Step Functions Express-only enforcement
  # WARNING: Standard workflows are required for executions >5 minutes.
  # Express workflows have 5-minute max duration limit.
  DenyHighCostStepFunctionsFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyHighCostStepFunctionsFeatures
      Description: |
        Force Express Workflows. WARNING: Standard workflows required for >5 min executions.
        Don't deploy if you have long-running workflows.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: ForceExpressWorkflows
            Effect: Deny
            Action:
              - 'states:CreateStateMachine'
              - 'states:UpdateStateMachine'
            Resource: '*'
            Condition:
              StringNotEquals:
                'states:StateMachineType': 'EXPRESS'
          - Sid: DenyBatchIntegrations
            Effect: Deny
            Action:
              - 'states:CreateStateMachine'
              - 'states:UpdateStateMachine'
            Resource: '*'
            Condition:
              StringLike:
                'states:Definition': '*arn:aws:states:::batch:*'
          - Sid: DenyEMRIntegrations
            Effect: Deny
            Action:
              - 'states:CreateStateMachine'
              - 'states:UpdateStateMachine'
            Resource: '*'
            Condition:
              StringLike:
                'states:Definition': '*arn:aws:states:::emr:*'
      TargetIds:
        - !Ref OrganizationRootId

  # Bedrock cost controls
  # WARNING: Bedrock is evolving rapidly. These actions/conditions may change.
  # Revisit this policy periodically as AWS updates Bedrock.
  DenyHighCostBedrockFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyHighCostBedrockFeatures
      Description: |
        Block expensive Bedrock features. WARNING: Bedrock API evolving rapidly.
        Conditions may become outdated. Revisit periodically.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyProvisionedThroughput
            Effect: Deny
            Action:
              - 'bedrock:CreateProvisionedModelThroughput'
              - 'bedrock:UpdateProvisionedModelThroughput'
              - 'bedrock:PutProvisionedModelThroughput'
            Resource: '*'
          - Sid: DenyCustomModelImport
            Effect: Deny
            Action:
              - 'bedrock:CreateModelImportJob'
              - 'bedrock:ImportCustomModel'
            Resource: '*'
          - Sid: DenyModelCustomization
            Effect: Deny
            Action:
              - 'bedrock:CreateModelCustomizationJob'
              - 'bedrock:CreateFineTuningJob'
              - 'bedrock:CreateContinuedPreTrainingJob'
            Resource: '*'
          - Sid: DenyMarketplaceModels
            Effect: Deny
            Action:
              - 'bedrock:CreateMarketplaceModelEndpoint'
              - 'bedrock:RegisterMarketplaceModelEndpoint'
              - 'aws-marketplace:Subscribe'
            Resource: '*'
            Condition:
              StringLike:
                'aws:RequestedService': 'bedrock'
          - Sid: DenyHumanEvaluation
            Effect: Deny
            Action:
              - 'bedrock:CreateEvaluationJob'
            Resource: '*'
            Condition:
              StringEquals:
                'bedrock:EvaluationType': 'Human'
          - Sid: DenyDataAutomationCustomOutput
            Effect: Deny
            Action:
              - 'bedrock:InvokeModel'
            Resource: '*'
            Condition:
              StringLike:
                'bedrock:ModelId': '*data-automation*'
              StringEquals:
                'bedrock:OutputType': 'Custom'
      TargetIds:
        - !Ref OrganizationRootId

  # Analytics edge cases - Glue dev endpoints, Athena provisioned capacity
  # Note: DenyAmazonMQ was migrated to scp-cost.yaml
  DenyExpensiveAnalyticsFeatures:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::Organizations::Policy
    Properties:
      Type: SERVICE_CONTROL_POLICY
      Name: DenyExpensiveAnalyticsFeatures
      Description: |
        Block expensive analytics features. These are edge cases unlikely to be used.
      Content:
        Version: 2012-10-17
        Statement:
          - Sid: DenyGlueDevelopmentEndpoints
            Effect: Deny
            Action:
              - 'glue:CreateDevEndpoint'
            Resource: '*'
          - Sid: DenyAthenaProvisionedCapacity
            Effect: Deny
            Action:
              - 'athena:CreateCapacityReservation'
            Resource: '*'
      TargetIds:
        - !Ref OrganizationRootId

Outputs:
  DenyHighCostLambdaFeaturesPolicyId:
    Description: Lambda High-Cost Features Deny SCP Policy ID
    Value: !Ref DenyHighCostLambdaFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyHighCostLambdaFeatures-PolicyId"
  DenyHighCostDynamoDBFeaturesPolicyId:
    Description: DynamoDB High-Cost Features Deny SCP Policy ID
    Value: !Ref DenyHighCostDynamoDBFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyHighCostDynamoDBFeatures-PolicyId"
  DenyHighCostAPIGatewayFeaturesPolicyId:
    Description: API Gateway High-Cost Features Deny SCP Policy ID
    Value: !Ref DenyHighCostAPIGatewayFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyHighCostAPIGatewayFeatures-PolicyId"
  DenyHighCostStepFunctionsPolicyId:
    Description: Step Functions High-Cost Features Deny SCP Policy ID
    Value: !Ref DenyHighCostStepFunctionsFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyHighCostStepFunctionsFeatures-PolicyId"
  DenyHighCostBedrockFeaturesPolicyId:
    Description: Bedrock High-Cost Features Deny SCP Policy ID
    Value: !Ref DenyHighCostBedrockFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyHighCostBedrockFeatures-PolicyId"
  DenyExpensiveAnalyticsFeaturesPolicyId:
    Description: Expensive Analytics Features Deny SCP Policy ID
    Value: !Ref DenyExpensiveAnalyticsFeatures
    Export:
      Name: !Sub "${AWS::StackName}-DenyExpensiveAnalyticsFeatures-PolicyId"
